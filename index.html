<!doctype html>
<html lang="en">
<head>
<title>Puppieeeeeees</title>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<link href="http://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="puppy.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

<script>
var current_word_count = 0; //warning check, puppies_earned calc
var words_per_reward = 100; //words per puppy
var last_puppy = 0; //last puppy shown at (! make sure to set this when page is initially loaded)
var warning_shown = false;

var next_puppy = {
  img_url: '',
  page_url: '',
  alt: ''
};

//my process: function looks at textarea, counts words, updates a span
//function called on keyUp
//document ready -- load content then call that function

function word_count(textvalue) { //onKeyUp textarea, wc = hidden_count (hidden input whose value gets updated)
  //autosave it
	if (typeof localStorage != "undefined") localStorage.text = text;
  //display warning if applic
	if (current_word_count >= 10 && warning_shown == false) {
    show_warning();
  }
	//consolidate whitespace
  text = text.replace(/^\s*|\s*$/g,''); //removes whitespace from front and end
  text = text.replace(/\s+/g,' '); // collapse multiple consecutive spaces
  //count words
	var words_list = text.split(" ");
	//update 
  current_word_count = words_list.length;
  $("#displayWords").html(current_word_count);
	//check for puppy
  if (current_word_count - last_puppy >= words_per_reward) {
    show_puppy();
  }
}

function show_warning() {
	if (typeof localStorage == "undefined"){
		$("#warning-no-ls").fadeIn("slow");
	} else {
		$("#warning-ls").fadeIn("slow");
	}
}

function hide_warning(id, immediate) {
  if (immediate == true) {
    $(id).hide();
  } else {
    $(id).fadeOut("slow");
  }
  warning_shown = true;
}

function show_puppy() {
//  console.log("show");
  hide_warning("#warning-ls", true);
  hide_warning("#warning-no-ls", true);
  last_puppy = current_word_count;
  $("#puppyFrame").css("background-image", "url(" + next_puppy.img_url + ")");
  $("#puppyCredit").html("<a href='" + next_puppy.page_url + "'>" + next_puppy.alt + "</a>");
  fetch_next_puppy();
}

function fetch_next_puppy() {
  if (tmp = getParameterByName("search")) {
    search = tmp;
  } else {
    search = "puppy,cute";
  }

  var flickr_url = "http://api.flickr.com/services/rest/?format=json&sort=interestingness-desc&method=flickr.photos.search&license=4&extras=owner_name&tags=" + search + "&tag_mode=all&api_key=5dfc80756edad8d0566cf40f0909324e&jsoncallback=?";

  $.getJSON(flickr_url, function(data) {
    if (data.stat == "ok") {
      var i = Math.ceil(Math.random() * 100);
      var photo = data.photos.photo[i];
      next_puppy.img_url = "http://farm" + photo.farm + ".static.flickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + "_z.jpg";
      next_puppy.page_url = "http://www.flickr.com/photos/" + photo.owner + "/" + photo.id;
      next_puppy.alt = photo.title + " by " + photo.ownername + " (under CC-BY)";
      $("#nextpuppy").attr("src", next_puppy.img_url);
    }
  });
}

function change_reward(num) { //set words per image
//  console.log("rewarding every " + num);
    words_per_reward = num;
}

function getParameterByName(name) {
  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.href);
  if (results == null)
    return "";
  else
    return decodeURIComponent(results[1].replace(/\+/g, " "));
}

function restore_text() {
  if (typeof localStorage != "undefined") $("#writearea").attr("value", localStorage.text).keyup();
}
</script>
</head>
<body onLoad="fetch_next_puppy(); restore_text()">
<div class="wrapper">
<a name="top"></a>
<h1>Puppieeeeeees</h1>
<div id="puppyFrame">
	<div id="warning-no-ls" class="warning" style="display:none">
		<h2>Warning!</h2>
		<p>We don't save your work for you! You'll need to regularly copy 
        and paste your text into a word processor or other application to save it permanently.</p>
    <p>If you want your work saved even if you close your browser,
    upgrade to a recent version of <a href="https://www.google.com/chrome/">Chrome</a>, 
      <a href="http://www.mozilla.org/firefox/">Firefox</a>, <a href="http://www.apple.com/safari/">Safari</a> 
      or <a href="http://www.opera.com/">Opera</a>.</p>
		<p class="hidelink"><a href="#" class="hide" onClick="hide_warning('#warning-no-ls')">OK, got it!</a></p>
  </div>
  <div id="warning-ls" class="warning" style="display:none">
		<h2>Hey!</h2>
		<p>Looks like your browser supports local storage.  That's great!  
        Your writing will be saved even if you close this page.</p>
    <p>We can't take responsibility for things going wrong, though, so you might want to 
    copy and paste your work to an external document every so often, just in case.</p>
		<p class="hidelink"><a href="#" class="hide" onClick="hide_warning('#warning-ls')">OK, got it!</a></p>
	</div>
	<div id="puppyCredit"></div>
</div>

<form>
	<input type="hidden" name="hidden_count" value="" disabled  />
	<textarea id="writearea" cols="80" rows="30" onKeyUp="word_count(this.value, hidden_count)"></textarea>
</form>
<form class="controls">
	<span class="meta">
	  Fresh puppy every <select id="howmany" onChange="change_reward(this.value)">
		<option value="100">100</option>
		<option value="200">200</option>
		<option value="500">500</option>
		<option value="1000">1000</option>
		</select> words
	</span>
	<span class="meta">
	Current word count: <span id="displayWords">0</span>
	</span>
</form>

</body>
</html>